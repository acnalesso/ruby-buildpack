#!/bin/bash

set -eo pipefail

TARGET_DIR=./targets

__parse_arguments() {
  rootfs=${1:-'lucid64'}
  target_name=${2:-'__unknown__'}
  target="$TARGET_DIR/${target_name}"
  version=${3:-'__unknown__'}
  patch=${4:-'__unknown__'}
}

__ensure_trusty_box() {
  vagrant up --provider=vmware_fusion
}

__build() {
  echo "-----> Ensuring vagrant Box is up"
  __ensure_trusty_box

  echo "-----> Running build in docker"
  vagrant ssh -c "sudo docker run -v /vagrant:/dependency-builder -w /dependency-builder cloudfoundry/${rootfs}_transitional $target $version $patch"

  if [ $rootfs == 'trusty64' ]; then
    rootfs_path_name="cflinuxfs2"
  else
    rootfs_path_name=$rootfs
  fi

  upload_bucket=s3://pivotal-buildpacks
  upload_path=/ruby/owned/binaries/$rootfs_path_name/
  upload_filename=${version}.tgz

  echo "-----> Uploading compiled binary (${upload_filename}) to S3"
  bin/gof3r cp out/${upload_filename} ${upload_bucket}${upload_path}ruby-${upload_filename}

}

__list() {
  echo "Available targets"
  echo
  ls $TARGET_DIR
}

__check_usage() {
  if [ -f $target ]; then
    __build
  else
    echo "ERROR: target definition '$target' not found"
    __list
  fi
}  

__parse_arguments $@
__check_usage
